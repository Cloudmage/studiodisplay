var $jscomp={scope:{},checkStringArgs:function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""}};
$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var b=$jscomp.checkStringArgs(this,a,"startsWith");a+="";for(var e=b.length,g=a.length,h=Math.max(0,Math.min(c|0,b.length)),f=0;f<g&&h<e;)if(b[h++]!=a[f++])return!1;return f>=g}},"es6-impl","es3");$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,c){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,c||0)}},"es6-impl","es3");var mySection="webclient",mqttSection="mqtt";
config=new ConfigIniParser;var mqtt,reconnectTimeout,reconnect,host,port,clientId,username,password,astronomyTopic,commandTopic,latitude,longitude,locale=Intl.DateTimeFormat().resolvedOptions().locale,timezoneLong=Intl.DateTimeFormat().resolvedOptions().timeZone,i18n;function date2HHmm(a){return a.toLocaleString(locale,{hour:"2-digit",minute:"2-digit",timeZone:timezoneLong})}
function HHmm2date(a){a=a.split(":");return 2===a.length?(hour=parseInt(a[0],10),minute=parseInt(a[1],10),second=0,date=new Date(null,null,null,hour,minute,second)):null}function HHmm2HHmm(a){return(a=HHmm2date(a))?date2HHmm(a):""}function numberCheck(a){return!isNaN(a)}function myRound(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}function setElement(a,b,c){c=void 0===c?"":c;if(a=document.getElementById(a))a.innerHTML=b?b:c}
function shorten(a,b){b=void 0===b?astronomyTopic:b;return a.replace(b,"")}function shortest(a){return a.split("/").pop()}function parentSubTopic(a){return a.split("/").splice(-2,1).pop()}function makeRGB(a,b){b=void 0===b?1:b;var c="",d=a.split(",").map(function(a){return a.trim()});3==d.length&&(c="rgba("+d[0]+","+d[1]+","+d[2]+","+b+")");return c}
function onConnect(){console.log("Connected to broker "+host+":"+port+" as user '"+username+"'");console.log("Subscribing to astronomy status at "+astronomyTopic+"#");mqtt.subscribe(astronomyTopic+"#");console.log("Subscribing to device command at "+commandTopic+"#");mqtt.subscribe(commandTopic+"#")}function onFailure(a){console.log("Connection to "+host+":"+port+" as user '"+username+"' failed");setTimeout(MQTTconnect,reconnectTimeout)}
function onMessageArrived(a){out_msg=a.destinationName+": "+a.payloadString;console.log(out_msg);var b=shorten(a.destinationName),c=shortest(a.destinationName);if(a.destinationName.startsWith(commandTopic))b=shorten(a.destinationName,commandTopic),["reload"].includes(b)?(console.log("RELOADING ..."),window.location.reload(!0)):console.log("Ignoring unknown command "+b);else{if("current"==parentSubTopic(a.destinationName))switch(c){case "background_color":document.documentElement.style.backgroundColor=
makeRGB(a.payloadString);break;case "text_color":document.documentElement.style.color=makeRGB(a.payloadString,.75);break;case "shortname":document.documentElement.style.backgroundImage="url('images/"+a.payloadString+".jpg')"}if(["background_color","text_color","shortname"].includes(c)){var d=parentSubTopic(a.destinationName),d=document.getElementsByClassName(d),b=document.getElementById(b);for(i=0;i<d.length;i++)switch(c){case "background_color":d[i].style.backgroundColor=makeRGB(a.payloadString);
b&&(b.style.backgroundColor=makeRGB(a.payloadString));break;case "text_color":d[i].style.color=makeRGB(a.payloadString,.75);b&&(b.style.color=makeRGB(a.payloadString,.75));break;case "shortname":d[i].style.backgroundImage="url('images/"+a.payloadString+".jpg')"}}else if(["lamp_color"].includes(c)){if(b=document.getElementById(b))b.style.backgroundColor=makeRGB(a.payloadString),b.style.color=makeRGB("0,0,0",.75)}else if(["timezone"].includes(c)&&(timezoneLong=a.payloadString),b=document.getElementById(b))b.innerHTML=
a.payloadString,["fullname"].includes(c)&&(b.innerHTML=i18n.__(a.payloadString)),["epoch","ts","timestamp"].includes(c)&&(b.innerHTML=a.payloadString?(new Date(1E3*Number(a.payloadString))).toLocaleString(locale,{hour:"2-digit",minute:"2-digit",timeZone:timezoneLong}):""),["age"].includes(c)&&(b.innerHTML="",b.className="wi wi-moon-"+a.payloadString),["percent"].includes(c)&&(b.innerHTML=Number(myRound(a.payloadString,0)).toLocaleString(locale)),["always_down"].includes(c)&&(setElement("moon/set/epoch",
i18n.__("always")),setElement("moon/rise/epoch","—")),["always_up"].includes(c)&&(setElement("moon/set/epoch","—"),setElement("moon/rise/epoch",i18n.__("always")))}}function onConnectionLost(a){console.log("Lost connection to "+a.uri+" ("+a.errorCode.toString()+")");a.reconnect?console.log("Automatic reconnect is active."):console.log("No automatic reconnect will be attempted.")}
function MQTTconnect(){console.log("Connecting to "+host+":"+port);mqtt=new Paho.MQTT.Client(host,port,clientId);var a={userName:username,password:password,timeout:3,reconnect:reconnect,onSuccess:onConnect,onFailure:onFailure};mqtt.onConnectionLost=onConnectionLost;mqtt.onMessageArrived=onMessageArrived;mqtt.connect(a)}var configfile=location.hostname?"config/"+location.hostname+".cfg":"config/unknown_host.cfg";console.log("Read configuration from "+configfile);fetch(configfile,{cache:"reload",mode:"no-cors"}).then(function(a){return a.text()}).then(function(a){return init1(a)});
function init1(a){console.log("Init stage 1: Configuration");config.parse(a);reconnectTimeout=config.getNumber(mySection,"reconnect_timeout");reconnect=config.getBoolean(mySection,"reconnect");host=config.get(mqttSection,"host");port=config.getNumber(mqttSection,"websockets_port");clientId=config.get(mySection,"client_id");username=config.get(mqttSection,"username");password=config.get(mqttSection,"password");astronomyTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"astronomy_topic");
commandTopic=config.get(mqttSection,"base_topic")+config.get(mySection,"client_topic")+"command/";latitude=config.getNumber(mySection,"latitude");longitude=config.getNumber(mySection,"longitude");timezoneLong=config.get(mySection,"timezone");locale=config.get(mySection,"locale");document.title=config.get(mySection,"title");fetch("config/lang-"+locale+".json",{cache:"reload",mode:"no-cors"}).then(function(a){return a.json()}).then(function(a){return init2(a)})}
function init2(a){console.log("Init stage 2: Localization");i18n=window.i18n();i18n.loadJSON(a,"messages");i18n.setLocale(locale);a=document.getElementsByClassName("i18n");for(i=0;i<a.length;i++)a[i].innerHTML=i18n.__(a[i].innerHTML);MQTTconnect()};
